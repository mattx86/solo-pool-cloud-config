#cloud-config
# Solo Mining Pool Server - Cloud Configuration
# Ubuntu 24.04 LTS
#
# Compatible with: Hetzner, AWS, GCP, Azure, DigitalOcean, Vultr, Linode, OVH, etc.
#
# INSTRUCTIONS:
# 1. Edit the CONFIGURATION VARIABLES section below
# 2. Paste into your cloud provider's cloud-config/user-data field
# 3. Launch your server
#
# All output is directed to /dev/tty1 for monitoring

# =============================================================================
# CONFIGURATION VARIABLES - EDIT THESE BEFORE DEPLOYMENT
# =============================================================================

write_files:
  - path: /opt/solo-pool/config.sh
    permissions: '0600'
    owner: root:root
    content: |
      #!/bin/bash
      # Solo Pool Configuration - Generated by cloud-init
      # This file is sourced by all setup scripts

      # ---------------------------------------------------------------------
      # SCRIPT SOURCE - Where to download setup scripts from
      # ---------------------------------------------------------------------
      # Change this to your GitHub raw URL or web server hosting the scripts
      SCRIPTS_BASE_URL="https://raw.githubusercontent.com/mattx86/solo-pool-cloud-config/main/scripts"

      # ---------------------------------------------------------------------
      # POOL SELECTION - Enable/disable each pool (true/false)
      # ---------------------------------------------------------------------
      ENABLE_BITCOIN_POOL="true"
      ENABLE_BCH_POOL="true"
      ENABLE_DGB_POOL="true"
      ENABLE_MONERO_POOL="true"
      ENABLE_TARI_POOL="true"
      ENABLE_ALEO_POOL="true"

      # ---------------------------------------------------------------------
      # MONERO/TARI MINING MODE
      # Options: "merge" (both via merge mining proxy)
      #          "monero_only" (XMR solo via monero-stratum)
      #          "tari_only" (XTM solo via minotari_miner)
      # ---------------------------------------------------------------------
      MONERO_TARI_MODE="merge"

      # ---------------------------------------------------------------------
      # WALLET ADDRESSES - Required for enabled pools
      # ---------------------------------------------------------------------
      BTC_WALLET_ADDRESS="YOUR_BTC_WALLET_ADDRESS_HERE"
      BCH_WALLET_ADDRESS="YOUR_BCH_WALLET_ADDRESS_HERE"
      DGB_WALLET_ADDRESS="YOUR_DGB_WALLET_ADDRESS_HERE"
      XMR_WALLET_ADDRESS="YOUR_XMR_WALLET_ADDRESS_HERE"
      XTM_WALLET_ADDRESS="YOUR_XTM_WALLET_ADDRESS_HERE"
      ALEO_WALLET_ADDRESS="YOUR_ALEO_WALLET_ADDRESS_HERE"

      # ---------------------------------------------------------------------
      # SSH CONFIGURATION
      # ---------------------------------------------------------------------
      SSH_PORT="22"

      # ---------------------------------------------------------------------
      # STRATUM PORTS - Ports miners connect to
      # ---------------------------------------------------------------------
      BTC_STRATUM_PORT="3333"
      BCH_STRATUM_PORT="3334"
      DGB_STRATUM_PORT="3335"
      XMR_STRATUM_PORT="3336"
      XTM_STRATUM_PORT="3337"
      MERGE_STRATUM_PORT="3338"

      # ---------------------------------------------------------------------
      # SYSTEM USER - Dedicated user for running pool services
      # ---------------------------------------------------------------------
      POOL_USER="pool"

      # ---------------------------------------------------------------------
      # DIRECTORY STRUCTURE
      # ---------------------------------------------------------------------
      BASE_DIR="/opt"
      CONFIG_DIR="/opt/solo-pool"
      SCRIPTS_DIR="/opt/solo-pool/scripts"
      NODE_DIR="/opt/node"
      POOL_DIR="/opt/pool"

      # Node directories
      BITCOIN_DIR="${NODE_DIR}/bitcoin"
      BCHN_DIR="${NODE_DIR}/bchn"
      DIGIBYTE_DIR="${NODE_DIR}/digibyte"
      MONERO_DIR="${NODE_DIR}/monero"
      TARI_DIR="${NODE_DIR}/tari"
      ALEO_DIR="${NODE_DIR}/aleo"

      # Pool directories
      CKPOOL_BTC_DIR="${POOL_DIR}/ckpool-btc"
      CKPOOL_BCH_DIR="${POOL_DIR}/ckpool-bch"
      CKPOOL_DGB_DIR="${POOL_DIR}/ckpool-dgb"
      MONERO_STRATUM_DIR="${POOL_DIR}/monero-stratum"
      TARI_MINER_DIR="${POOL_DIR}/tari-miner"
      TARI_MERGE_DIR="${POOL_DIR}/tari-merge-proxy"

      # ---------------------------------------------------------------------
      # VERSION PINNING - Update these as needed
      # ---------------------------------------------------------------------
      BITCOIN_VERSION="27.1"
      BCHN_VERSION="27.1.0"
      DIGIBYTE_VERSION="7.17.3"
      MONERO_VERSION="0.18.3.4"
      # Tari and ALEO use latest releases from GitHub

      # ---------------------------------------------------------------------
      # HELPER FUNCTIONS
      # ---------------------------------------------------------------------
      log() {
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" >/dev/tty1 2>&1
      }

      log_error() {
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] ERROR: $*" >/dev/tty1 2>&1
      }

      log_success() {
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] SUCCESS: $*" >/dev/tty1 2>&1
      }

      run_cmd() {
          "$@" >/dev/tty1 2>&1
      }

# =============================================================================
# CLOUD-INIT EXECUTION
# =============================================================================

runcmd:
  # Ensure /dev/tty1 is available for output (create symlink if needed for cloud environments)
  - |
    if [ ! -e /dev/tty1 ]; then
      # Some cloud environments don't have tty1, use console instead
      ln -sf /dev/console /dev/tty1 2>/dev/null || true
    fi
    exec >/dev/tty1 2>&1
    echo "=============================================="
    echo "Solo Mining Pool Setup - Starting"
    echo "$(date)"
    echo "=============================================="

  # Create directory structure
  - mkdir -p /opt/solo-pool/scripts >/dev/tty1 2>&1

  # Make config readable
  - chmod 600 /opt/solo-pool/config.sh >/dev/tty1 2>&1

  # Source config to get SCRIPTS_BASE_URL
  - |
    source /opt/solo-pool/config.sh
    echo "Scripts will be downloaded from: ${SCRIPTS_BASE_URL}" >/dev/tty1 2>&1

  # Download all scripts
  - |
    source /opt/solo-pool/config.sh
    cd /opt/solo-pool/scripts

    SCRIPTS=(
      "01-system-update.sh"
      "02-cis-hardening.sh"
      "03-ufw-setup.sh"
      "04-user-setup.sh"
      "05-install-dependencies.sh"
      "10-install-bitcoin.sh"
      "11-install-bch.sh"
      "12-install-digibyte.sh"
      "13-install-monero.sh"
      "14-install-tari.sh"
      "15-install-aleo.sh"
      "20-configure-services.sh"
      "99-finalize.sh"
    )

    echo "Downloading setup scripts..." >/dev/tty1 2>&1
    for script in "${SCRIPTS[@]}"; do
      echo "  Downloading ${script}..." >/dev/tty1 2>&1
      wget -q "${SCRIPTS_BASE_URL}/${script}" -O "${script}" >/dev/tty1 2>&1
      if [ $? -eq 0 ]; then
        chmod +x "${script}"
        echo "    OK" >/dev/tty1 2>&1
      else
        echo "    FAILED - Check SCRIPTS_BASE_URL in config" >/dev/tty1 2>&1
      fi
    done

  # Execute scripts in order
  - |
    source /opt/solo-pool/config.sh
    cd /opt/solo-pool/scripts

    echo "" >/dev/tty1 2>&1
    echo "=============================================="  >/dev/tty1 2>&1
    echo "Executing setup scripts..."  >/dev/tty1 2>&1
    echo "=============================================="  >/dev/tty1 2>&1

    # 01 - System Update
    if [ -x "./01-system-update.sh" ]; then
      echo "" >/dev/tty1 2>&1
      echo "[STEP 1/13] Running system update..." >/dev/tty1 2>&1
      ./01-system-update.sh
    fi

    # 02 - CIS Hardening
    if [ -x "./02-cis-hardening.sh" ]; then
      echo "" >/dev/tty1 2>&1
      echo "[STEP 2/13] Applying CIS hardening..." >/dev/tty1 2>&1
      ./02-cis-hardening.sh
    fi

    # 03 - UFW Setup
    if [ -x "./03-ufw-setup.sh" ]; then
      echo "" >/dev/tty1 2>&1
      echo "[STEP 3/13] Configuring firewall..." >/dev/tty1 2>&1
      ./03-ufw-setup.sh
    fi

    # 04 - User Setup
    if [ -x "./04-user-setup.sh" ]; then
      echo "" >/dev/tty1 2>&1
      echo "[STEP 4/13] Creating pool user and directories..." >/dev/tty1 2>&1
      ./04-user-setup.sh
    fi

    # 05 - Install Dependencies
    if [ -x "./05-install-dependencies.sh" ]; then
      echo "" >/dev/tty1 2>&1
      echo "[STEP 5/13] Installing build dependencies..." >/dev/tty1 2>&1
      ./05-install-dependencies.sh
    fi

    # 10 - Install Bitcoin
    if [ -x "./10-install-bitcoin.sh" ]; then
      echo "" >/dev/tty1 2>&1
      echo "[STEP 6/13] Installing Bitcoin node and pool..." >/dev/tty1 2>&1
      ./10-install-bitcoin.sh
    fi

    # 11 - Install BCH
    if [ -x "./11-install-bch.sh" ]; then
      echo "" >/dev/tty1 2>&1
      echo "[STEP 7/13] Installing Bitcoin Cash node and pool..." >/dev/tty1 2>&1
      ./11-install-bch.sh
    fi

    # 12 - Install DigiByte
    if [ -x "./12-install-digibyte.sh" ]; then
      echo "" >/dev/tty1 2>&1
      echo "[STEP 8/13] Installing DigiByte node and pool..." >/dev/tty1 2>&1
      ./12-install-digibyte.sh
    fi

    # 13 - Install Monero
    if [ -x "./13-install-monero.sh" ]; then
      echo "" >/dev/tty1 2>&1
      echo "[STEP 9/13] Installing Monero node and stratum..." >/dev/tty1 2>&1
      ./13-install-monero.sh
    fi

    # 14 - Install Tari
    if [ -x "./14-install-tari.sh" ]; then
      echo "" >/dev/tty1 2>&1
      echo "[STEP 10/13] Installing Tari node and mining software..." >/dev/tty1 2>&1
      ./14-install-tari.sh
    fi

    # 15 - Install ALEO
    if [ -x "./15-install-aleo.sh" ]; then
      echo "" >/dev/tty1 2>&1
      echo "[STEP 11/13] Installing ALEO snarkOS..." >/dev/tty1 2>&1
      ./15-install-aleo.sh
    fi

    # 20 - Configure Services
    if [ -x "./20-configure-services.sh" ]; then
      echo "" >/dev/tty1 2>&1
      echo "[STEP 12/13] Configuring systemd services..." >/dev/tty1 2>&1
      ./20-configure-services.sh
    fi

    # 99 - Finalize
    if [ -x "./99-finalize.sh" ]; then
      echo "" >/dev/tty1 2>&1
      echo "[STEP 13/13] Finalizing installation..." >/dev/tty1 2>&1
      ./99-finalize.sh
    fi

    echo "" >/dev/tty1 2>&1
    echo "=============================================="  >/dev/tty1 2>&1
    echo "Solo Mining Pool Setup - Complete"  >/dev/tty1 2>&1
    echo "$(date)"  >/dev/tty1 2>&1
    echo "=============================================="  >/dev/tty1 2>&1
    echo "" >/dev/tty1 2>&1
    echo "Next steps:" >/dev/tty1 2>&1
    echo "1. Wait for blockchain nodes to sync" >/dev/tty1 2>&1
    echo "2. Open firewall ports when ready: sudo ufw allow <port>/tcp" >/dev/tty1 2>&1
    echo "3. Check service status: sudo systemctl status <service>" >/dev/tty1 2>&1
    echo "" >/dev/tty1 2>&1

# Final message
final_message: |
  Solo Mining Pool server setup complete!

  Configuration: /opt/solo-pool/config.sh
  Scripts: /opt/solo-pool/scripts/
  Nodes: /opt/node/
  Pools: /opt/pool/

  Check service status with: systemctl status <service-name>
  View logs with: journalctl -u <service-name> -f

# =============================================================================
# PROVIDER-SPECIFIC NOTES
# =============================================================================
#
# AWS EC2:
#   - Use this as "User data" when launching an instance
#   - Ensure security group allows SSH (port 22)
#   - Consider using EBS volume for /opt (blockchain data)
#
# Google Cloud (GCP):
#   - Use this in "Automation > Startup script" or as metadata
#   - Key: user-data, Value: contents of this file
#
# Azure:
#   - Use this as "Custom data" in the VM creation
#   - May need to base64 encode depending on method
#
# DigitalOcean:
#   - Use this in "User data" field when creating droplet
#
# Vultr:
#   - Use this in "Cloud-Init User-Data" field
#
# Linode:
#   - Use StackScripts or paste in "User Data" field
#
# OVH:
#   - Use this in "Post-installation script" field
#
