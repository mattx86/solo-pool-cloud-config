#cloud-config
# Solo Mining Pool Server - Cloud Configuration
# Ubuntu 24.04 LTS
#
# Compatible with: Hetzner, AWS, GCP, Azure, DigitalOcean, Vultr, Linode, OVH, etc.
#
# INSTRUCTIONS:
# 1. Edit the CONFIGURATION VARIABLES section below
# 2. Paste into your cloud provider's cloud-config/user-data field
# 3. Launch your server
#
# All output is directed to /dev/tty1 for monitoring

# =============================================================================
# CONFIGURATION VARIABLES - EDIT THESE BEFORE DEPLOYMENT
# =============================================================================

write_files:
  - path: /opt/solo-pool/install/config.sh
    permissions: '0600'
    owner: root:root
    content: |
      #!/bin/bash
      # Solo Pool Configuration - Generated by cloud-init
      # This file is sourced by all setup scripts

      # ---------------------------------------------------------------------
      # SCRIPT SOURCE - Where to download setup scripts from
      # ---------------------------------------------------------------------
      # Change this to your GitHub raw URL or web server hosting the scripts
      SCRIPTS_BASE_URL="https://raw.githubusercontent.com/mattx86/solo-pool-cloud-config/refs/heads/main/install"

      # ---------------------------------------------------------------------
      # NETWORK MODE - Testing vs Production
      # ---------------------------------------------------------------------
      # Options: "mainnet" (production) or "testnet" (testing)
      # - mainnet: Real coins, real blockchain, production use
      # - testnet: Public test networks for testing without real funds
      #            Bitcoin/BCH/DGB use testnet, Monero uses stagenet,
      #            Tari uses esmeralda, ALEO uses testnet
      NETWORK_MODE="mainnet"

      # ---------------------------------------------------------------------
      # POOL SELECTION - Enable/disable each pool (true/false)
      # ---------------------------------------------------------------------
      ENABLE_BITCOIN_POOL="true"
      ENABLE_BCH_POOL="true"
      ENABLE_DGB_POOL="true"
      ENABLE_MONERO_POOL="true"
      ENABLE_TARI_POOL="true"
      ENABLE_ALEO_POOL="true"

      # ---------------------------------------------------------------------
      # MONERO/TARI MINING MODE
      # Options: "merge" (both via merge mining proxy)
      #          "monero_only" (XMR solo via monero-pool)
      #          "tari_only" (XTM solo via minotari_miner)
      # ---------------------------------------------------------------------
      MONERO_TARI_MODE="merge"

      # ---------------------------------------------------------------------
      # SSH CONFIGURATION
      # ---------------------------------------------------------------------
      SSH_PORT="22"

      # ---------------------------------------------------------------------
      # STRATUM PORTS - Ports miners connect to
      # ---------------------------------------------------------------------
      BTC_STRATUM_PORT="3333"
      BCH_STRATUM_PORT="3334"
      DGB_STRATUM_PORT="3335"
      XMR_STRATUM_PORT="3336"
      XTM_STRATUM_PORT="3337"
      XMR_XTM_MERGE_STRATUM_PORT="3338"
      ALEO_STRATUM_PORT="3339"

      # ---------------------------------------------------------------------
      # POOL API PORTS - Internal ports for pool software stats
      # ---------------------------------------------------------------------
      # monero-pool WebUI/API port (for stats/shares)
      MONERO_POOL_API_PORT="4243"
      # Merge mining proxy stats API
      MERGE_PROXY_API_PORT="18081"
      # Minotari miner stats API (for tari_only mode)
      TARI_MINER_API_PORT="18084"
      # ALEO pool server stats API
      ALEO_POOL_API_PORT="4000"

      # ---------------------------------------------------------------------
      # PAYMENT PROCESSOR
      # ---------------------------------------------------------------------
      # Payment processor REST API port (for WebUI integration)
      PAYMENTS_API_PORT="8081"

      # ---------------------------------------------------------------------
      # NODE RPC PORTS - For pool software to communicate with nodes
      # ---------------------------------------------------------------------
      # Bitcoin Core RPC
      BITCOIN_RPC_PORT="8332"
      # Bitcoin Cash Node RPC
      BCH_RPC_PORT="8334"
      # DigiByte Core RPC
      DGB_RPC_PORT="14022"
      # Monero daemon RPC (JSON-RPC)
      MONERO_RPC_PORT="18081"
      # Tari node GRPC
      TARI_NODE_GRPC_PORT="18142"
      # ALEO snarkOS REST API
      ALEO_REST_PORT="3030"
      # ALEO snarkOS RPC (for transactions)
      ALEO_RPC_PORT="3033"

      # ---------------------------------------------------------------------
      # WALLET RPC PORTS - For payment processor to send transactions
      # ---------------------------------------------------------------------
      # Monero wallet RPC (monero-wallet-rpc)
      MONERO_WALLET_RPC_PORT="18082"
      # Tari console wallet GRPC
      TARI_WALLET_GRPC_PORT="18143"

      # ---------------------------------------------------------------------
      # ZMQ PORTS - For real-time block/transaction notifications
      # ---------------------------------------------------------------------
      # Bitcoin ZMQ
      BITCOIN_ZMQ_BLOCK_PORT="28332"
      BITCOIN_ZMQ_TX_PORT="28333"
      # Bitcoin Cash ZMQ
      BCH_ZMQ_BLOCK_PORT="28334"
      BCH_ZMQ_TX_PORT="28335"
      # DigiByte ZMQ
      DGB_ZMQ_BLOCK_PORT="28336"
      DGB_ZMQ_TX_PORT="28337"
      # Monero ZMQ
      MONERO_ZMQ_PORT="18083"

      # ---------------------------------------------------------------------
      # P2P PORTS - For node-to-node communication (optional, for reference)
      # ---------------------------------------------------------------------
      # These are standard ports used by the blockchain networks
      # BITCOIN_P2P_PORT="8333"
      # BCH_P2P_PORT="8335"
      # DGB_P2P_PORT="12024"
      # MONERO_P2P_PORT="18080"
      # TARI_P2P_PORT="18189"
      # ALEO_P2P_PORT="4130"
      # Note: monero-pool uses XMR_STRATUM_PORT (3336) for stratum connections

      # ---------------------------------------------------------------------
      # STARTING DIFFICULTY - Initial difficulty for miners
      # ---------------------------------------------------------------------
      # Set ENABLE_CUSTOM_DIFFICULTY="true" to use custom starting difficulties
      # When disabled, pools use their default starting difficulties
      ENABLE_CUSTOM_DIFFICULTY="false"

      # CKPool (BTC/BCH/DGB) - Default: 6000 (tuned for Avalon Nano 3S @ 6 TH/s)
      # Formula: difficulty = hashrate_TH × 1000 (targets ~3 second share intervals)
      # Adjust based on your miners: 1 TH/s = 1000, 100 TH/s = 100000
      BTC_START_DIFFICULTY="6000"
      BCH_START_DIFFICULTY="6000"
      DGB_START_DIFFICULTY="6000"

      # monero-pool (XMR) - Default: 4500 (tuned for 1.5 KH/s RandomX)
      # monero-pool uses vardiff, but this sets the initial difficulty
      # Formula: difficulty = hashrate_KH × 3 (targets ~3 second share intervals)
      XMR_START_DIFFICULTY="4500"

      # Tari (XTM) - Default: 4500 (tuned for 1.5 KH/s RandomX)
      XTM_START_DIFFICULTY="4500"

      # Merge Mining Proxy (XMR+XTM) - Default: 4500 (tuned for 1.5 KH/s RandomX)
      XMR_XTM_MERGE_START_DIFFICULTY="4500"

      # ALEO - Default: 1 (tuned for IceRiver AE0 @ 60 MH/s)
      # ALEO uses zkSNARK proof generation, difficulty scaling differs from hash mining
      ALEO_START_DIFFICULTY="1"

      # ---------------------------------------------------------------------
      # NETWORK MODE - P2P connectivity settings
      # ---------------------------------------------------------------------
      # Set to "false" for outbound-only mode (recommended for private pools)
      # This reduces attack surface and simplifies firewall - only stratum ports needed
      # Set to "true" to accept incoming P2P connections from coin networks
      ENABLE_INBOUND_P2P="false"

      # ---------------------------------------------------------------------
      # WEB UI CONFIGURATION
      # ---------------------------------------------------------------------
      # Enable/disable WebUI entirely
      ENABLE_WEBUI="true"
      # HTTP server settings (disabled by default - use HTTPS)
      WEBUI_HTTP_ENABLED="false"
      WEBUI_HTTP_PORT="8080"
      # HTTPS server settings (uses self-signed 10-year certificate)
      WEBUI_HTTPS_ENABLED="true"
      WEBUI_HTTPS_PORT="8443"
      # Stats refresh interval in seconds (how often to poll pool backends)
      WEBUI_REFRESH_INTERVAL="15"
      # WebUI authentication username (password is auto-generated)
      WEBUI_USER="admin"

      # ---------------------------------------------------------------------
      # MAINTENANCE SCHEDULING
      # ---------------------------------------------------------------------
      # Daily maintenance time (SQLite optimization, log rotation, backup)
      # Uses system timezone. Default: 2:15 AM
      MAINTENANCE_HOUR="2"
      MAINTENANCE_MINUTE="15"

      # ---------------------------------------------------------------------
      # LOG RETENTION AND ROTATION
      # ---------------------------------------------------------------------
      # Number of days to keep log files before deletion
      LOG_RETENTION_DAYS="30"
      # Number of days before compressing rotated logs (keeps recent logs uncompressed for easy access)
      LOG_COMPRESS_AFTER_DAYS="7"

      # ---------------------------------------------------------------------
      # BACKUP CONFIGURATION
      # ---------------------------------------------------------------------
      # Directory to store backups (excluded from backup itself)
      BACKUP_DIR="${BASE_DIR}/backups"
      # Maximum age of backups in days (older backups are deleted)
      BACKUP_RETENTION_DAYS="30"

      # ---------------------------------------------------------------------
      # SYSTEM USER - Dedicated user for running pool services
      # ---------------------------------------------------------------------
      POOL_USER="pool"

      # ---------------------------------------------------------------------
      # DIRECTORY STRUCTURE
      # ---------------------------------------------------------------------
      BASE_DIR="/opt/solo-pool"
      BIN_DIR="${BASE_DIR}/bin"
      INSTALL_DIR="${BASE_DIR}/install"
      NODE_DIR="${BASE_DIR}/node"
      POOL_DIR="${BASE_DIR}/pool"

      # Node directories
      BITCOIN_DIR="${NODE_DIR}/bitcoin"
      BCHN_DIR="${NODE_DIR}/bchn"
      DIGIBYTE_DIR="${NODE_DIR}/digibyte"
      MONERO_DIR="${NODE_DIR}/monero"
      TARI_DIR="${NODE_DIR}/tari"
      ALEO_DIR="${NODE_DIR}/aleo"

      # Pool directories
      BTC_CKPOOL_DIR="${POOL_DIR}/btc-ckpool"
      BCH_CKPOOL_DIR="${POOL_DIR}/bch-ckpool"
      DGB_CKPOOL_DIR="${POOL_DIR}/dgb-ckpool"
      XMR_MONERO_POOL_DIR="${POOL_DIR}/xmr-monero-pool"
      XTM_MINER_DIR="${POOL_DIR}/xtm-minotari-miner"
      XMR_XTM_MERGE_DIR="${POOL_DIR}/xmr-xtm-minotari-merge-proxy"
      ALEO_POOL_DIR="${POOL_DIR}/aleo-pool-server"

      # WebUI directory
      WEBUI_DIR="${BASE_DIR}/webui"

      # Payments processor directory
      PAYMENTS_DIR="${BASE_DIR}/payments"

      # CKPool socket directories (for API communication with WebUI)
      BTC_CKPOOL_SOCKET_DIR="/tmp/ckpool-btc"
      BCH_CKPOOL_SOCKET_DIR="/tmp/ckpool-bch"
      DGB_CKPOOL_SOCKET_DIR="/tmp/ckpool-dgb"

      # ---------------------------------------------------------------------
      # VERSION PINNING - Node Software
      # ---------------------------------------------------------------------
      BITCOIN_VERSION="30.0"
      BCHN_VERSION="28.0.1"
      DIGIBYTE_VERSION="8.26.1"
      MONERO_VERSION="0.18.4.4"
      TARI_VERSION="5.1.0"
      SNARKOS_VERSION="4.4.0"

      # ---------------------------------------------------------------------
      # VERSION PINNING - Pool Software
      # ---------------------------------------------------------------------
      # CKPool: No formal releases, pinned to specific commit
      CKPOOL_COMMIT="590fb2a2c6164beb85d458b3a212723507a9d8ac"
      # monero-pool: Monero mining pool with share tracking (jtgrassie/monero-pool)
      MONERO_POOL_COMMIT="master"
      # ALEO Pool Server: Stratum server for ALEO ASIC mining
      ALEO_POOL_COMMIT="992792eb9aaf29fde0c20c9942ec5a9244a4a0a6"

      # ---------------------------------------------------------------------
      # LOGGING
      # ---------------------------------------------------------------------
      LOG_FILE="${INSTALL_DIR}/install.log"

      # ---------------------------------------------------------------------
      # HELPER FUNCTIONS
      # ---------------------------------------------------------------------
      log() {
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "${LOG_FILE}" >/dev/tty1 2>&1
      }

      log_error() {
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] ERROR: $*" | tee -a "${LOG_FILE}" >/dev/tty1 2>&1
      }

      log_success() {
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] SUCCESS: $*" | tee -a "${LOG_FILE}" >/dev/tty1 2>&1
      }

      run_cmd() {
          "$@" 2>&1 | tee -a "${LOG_FILE}" >/dev/tty1
      }

      # Validation function - call this after sourcing to verify config loaded
      validate_config() {
          local errors=0

          # Check essential variables
          if [ -z "${SCRIPTS_BASE_URL:-}" ]; then
              echo "ERROR: SCRIPTS_BASE_URL not defined" >&2
              ((errors++))
          fi
          if [ -z "${BASE_DIR:-}" ]; then
              echo "ERROR: BASE_DIR not defined" >&2
              ((errors++))
          fi
          if [ -z "${POOL_USER:-}" ]; then
              echo "ERROR: POOL_USER not defined" >&2
              ((errors++))
          fi

          return $errors
      }

      # Mark that config was successfully loaded
      CONFIG_LOADED="true"

# =============================================================================
# CLOUD-INIT EXECUTION
# =============================================================================

runcmd:
  # Create directory structure first (needed for log file)
  - mkdir -p /opt/solo-pool/install

  # Ensure /dev/tty1 is available for output (create symlink if needed for cloud environments)
  - |
    if [ ! -e /dev/tty1 ]; then
      # Some cloud environments don't have tty1, use console instead
      ln -sf /dev/console /dev/tty1 2>/dev/null || true
    fi
    LOG_FILE="/opt/solo-pool/install/install.log"
    echo "=============================================="  | tee -a "${LOG_FILE}" >/dev/tty1 2>&1
    echo "Solo Mining Pool Setup - Starting"             | tee -a "${LOG_FILE}" >/dev/tty1 2>&1
    echo "$(date)"                                       | tee -a "${LOG_FILE}" >/dev/tty1 2>&1
    echo "=============================================="  | tee -a "${LOG_FILE}" >/dev/tty1 2>&1

  # Make config readable
  - chmod 600 /opt/solo-pool/install/config.sh

  # Source config to get SCRIPTS_BASE_URL
  - |
    source /opt/solo-pool/install/config.sh
    log "Scripts will be downloaded from: ${SCRIPTS_BASE_URL}"

  # Download all scripts
  - |
    source /opt/solo-pool/install/config.sh
    cd /opt/solo-pool/install

    SCRIPTS=(
      "01-system-update.sh"
      "02-cis-hardening.sh"
      "03-ufw-setup.sh"
      "04-user-setup.sh"
      "05-install-dependencies.sh"
      "10-install-bitcoin.sh"
      "11-install-bch.sh"
      "12-install-digibyte.sh"
      "13-install-monero.sh"
      "14-install-tari.sh"
      "15-install-aleo.sh"
      "16-install-webui.sh"
      "17-install-payments.sh"
      "20-configure-services.sh"
      "99-finalize.sh"
    )

    log "Downloading setup scripts..."
    for script in "${SCRIPTS[@]}"; do
      log "  Downloading ${script}..."
      wget -q "${SCRIPTS_BASE_URL}/${script}" -O "${script}" 2>&1 | tee -a "${LOG_FILE}" >/dev/tty1
      if [ $? -eq 0 ]; then
        chmod +x "${script}"
        log "    OK"
      else
        log_error "    FAILED - Check SCRIPTS_BASE_URL in config"
      fi
    done

  # Execute scripts in order
  - |
    source /opt/solo-pool/install/config.sh
    cd /opt/solo-pool/install

    log ""
    log "=============================================="
    log "Executing setup scripts..."
    log "=============================================="

    # 01 - System Update
    if [ -x "./01-system-update.sh" ]; then
      log ""
      log "[STEP 1/15] Running system update..."
      ./01-system-update.sh
    fi

    # 02 - CIS Hardening
    if [ -x "./02-cis-hardening.sh" ]; then
      log ""
      log "[STEP 2/15] Applying CIS hardening..."
      ./02-cis-hardening.sh
    fi

    # 03 - UFW Setup
    if [ -x "./03-ufw-setup.sh" ]; then
      log ""
      log "[STEP 3/15] Configuring firewall..."
      ./03-ufw-setup.sh
    fi

    # 04 - User Setup
    if [ -x "./04-user-setup.sh" ]; then
      log ""
      log "[STEP 4/15] Creating pool user and directories..."
      ./04-user-setup.sh
    fi

    # 05 - Install Dependencies
    if [ -x "./05-install-dependencies.sh" ]; then
      log ""
      log "[STEP 5/15] Installing build dependencies..."
      ./05-install-dependencies.sh
    fi

    # 10 - Install Bitcoin
    if [ -x "./10-install-bitcoin.sh" ]; then
      log ""
      log "[STEP 6/15] Installing Bitcoin node and pool..."
      ./10-install-bitcoin.sh
    fi

    # 11 - Install BCH
    if [ -x "./11-install-bch.sh" ]; then
      log ""
      log "[STEP 7/15] Installing Bitcoin Cash node and pool..."
      ./11-install-bch.sh
    fi

    # 12 - Install DigiByte
    if [ -x "./12-install-digibyte.sh" ]; then
      log ""
      log "[STEP 8/15] Installing DigiByte node and pool..."
      ./12-install-digibyte.sh
    fi

    # 13 - Install Monero
    if [ -x "./13-install-monero.sh" ]; then
      log ""
      log "[STEP 9/15] Installing Monero node and stratum..."
      ./13-install-monero.sh
    fi

    # 14 - Install Tari
    if [ -x "./14-install-tari.sh" ]; then
      log ""
      log "[STEP 10/15] Installing Tari node and mining software..."
      ./14-install-tari.sh
    fi

    # 15 - Install ALEO
    if [ -x "./15-install-aleo.sh" ]; then
      log ""
      log "[STEP 11/15] Installing ALEO snarkOS..."
      ./15-install-aleo.sh
    fi

    # 16 - Install WebUI
    if [ -x "./16-install-webui.sh" ]; then
      log ""
      log "[STEP 12/15] Installing WebUI dashboard..."
      ./16-install-webui.sh
    fi

    # 17 - Install Payment Processor
    if [ -x "./17-install-payments.sh" ]; then
      log ""
      log "[STEP 13/15] Installing payment processor..."
      ./17-install-payments.sh
    fi

    # 20 - Configure Services
    if [ -x "./20-configure-services.sh" ]; then
      log ""
      log "[STEP 14/15] Configuring systemd services..."
      ./20-configure-services.sh
    fi

    # 99 - Finalize
    if [ -x "./99-finalize.sh" ]; then
      log ""
      log "[STEP 15/15] Finalizing installation..."
      ./99-finalize.sh
    fi

    log ""
    log "=============================================="
    log "Solo Mining Pool Setup - Complete"
    log "$(date)"
    log "=============================================="
    log ""
    log "Next steps:"
    log "1. Wait for blockchain nodes to sync"
    log "2. Open firewall ports when ready: sudo ufw allow <port>/tcp"
    log "3. Check service status: sudo systemctl status <service>"
    log ""

# Final message
final_message: |
  Solo Mining Pool server setup complete!

  Management Scripts: /opt/solo-pool/bin/
  Install Scripts: /opt/solo-pool/install/
  Configuration: /opt/solo-pool/install/config.sh
  Install Log: /opt/solo-pool/install/install.log
  Nodes: /opt/solo-pool/node/
  Pools: /opt/solo-pool/pool/

  Check service status with: systemctl status <service-name>
  View logs with: journalctl -u <service-name> -f

# =============================================================================
# PROVIDER-SPECIFIC NOTES
# =============================================================================
#
# AWS EC2:
#   - Use this as "User data" when launching an instance
#   - Ensure security group allows SSH (port 22)
#   - Consider using EBS volume for /opt (blockchain data)
#
# Google Cloud (GCP):
#   - Use this in "Automation > Startup script" or as metadata
#   - Key: user-data, Value: contents of this file
#
# Azure:
#   - Use this as "Custom data" in the VM creation
#   - May need to base64 encode depending on method
#
# DigitalOcean:
#   - Use this in "User data" field when creating droplet
#
# Vultr:
#   - Use this in "Cloud-Init User-Data" field
#
# Linode:
#   - Use StackScripts or paste in "User Data" field
#
# OVH:
#   - Use this in "Post-installation script" field
#
